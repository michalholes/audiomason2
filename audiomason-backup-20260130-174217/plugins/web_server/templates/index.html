<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioMason v2 - Web Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .file-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            background: #f8f9fa;
            border-color: #764ba2;
        }
        
        .file-upload input {
            display: none;
        }
        
        .jobs-list {
            list-style: none;
        }
        
        .job-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .job-info h4 {
            color: #495057;
            margin-bottom: 5px;
        }
        
        .job-info p {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-processing {
            background: #ffc107;
            color: white;
        }
        
        .status-done {
            background: #28a745;
            color: white;
        }
        
        .status-error {
            background: #dc3545;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h2 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .config-item label {
            font-weight: 600;
            color: #495057;
        }
        
        .config-item input {
            width: 300px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        #connectionStatus {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .connected {
            background: #28a745;
            color: white;
        }
        
        .disconnected {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="disconnected">‚óè Disconnected</div>
    
    <div class="container">
        <div class="header">
            <h1>üéß AudioMason v2</h1>
            <p>Complete Web Control Panel</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('process')">üéµ Process Books</button>
            <button class="tab" onclick="switchTab('queue')">üìã Queue</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Config</button>
            <button class="tab" onclick="switchTab('checkpoints')">üíæ Checkpoints</button>
        </div>
        
        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h2 id="statActiveJobs">0</h2>
                    <p>Active Jobs</p>
                </div>
                <div class="stat-card">
                    <h2 id="statCompleted">0</h2>
                    <p>Completed</p>
                </div>
                <div class="stat-card">
                    <h2 id="statErrors">0</h2>
                    <p>Errors</p>
                </div>
            </div>
            
            <div class="card">
                <h3>System Status</h3>
                <p><strong>Status:</strong> <span id="systemStatus">Running</span></p>
                <p><strong>Version:</strong> 2.0.0-alpha</p>
                <p><strong>API URL:</strong> <code id="apiUrl">http://localhost:8080</code></p>
            </div>
            
            <div class="card">
                <h3>Recent Activity</h3>
                <ul id="recentActivity" class="jobs-list">
                    <li>No recent activity</li>
                </ul>
            </div>
        </div>
        
        <!-- PROCESS TAB -->
        <div id="process" class="tab-content">
            <div id="uploadAlert" class="alert hidden"></div>
            
            <div class="card">
                <h3>Upload Audio File</h3>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".m4a,.m4b,.opus,.mp3" onchange="handleFileSelect(event)">
                    <p style="font-size: 3em; margin-bottom: 10px;">üìÅ</p>
                    <p style="font-size: 1.2em; font-weight: 600; margin-bottom: 5px;">Click to upload</p>
                    <p style="color: #6c757d;">M4A, M4B, Opus, or MP3 files</p>
                    <p id="selectedFile" style="margin-top: 15px; color: #667eea; font-weight: 600;"></p>
                </div>
            </div>
            
            <div class="card">
                <h3>Book Information</h3>
                <div class="form-group">
                    <label>Author *</label>
                    <input type="text" id="author" placeholder="George Orwell" required>
                </div>
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="title" placeholder="1984" required>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="year" placeholder="1949">
                </div>
            </div>
            
            <div class="card">
                <h3>Processing Options</h3>
                <div class="form-group">
                    <label>Audio Bitrate</label>
                    <select id="bitrate">
                        <option value="96k">96k</option>
                        <option value="128k" selected>128k</option>
                        <option value="192k">192k</option>
                        <option value="256k">256k</option>
                        <option value="320k">320k</option>
                    </select>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="loudnorm">
                    <label for="loudnorm">Enable Loudness Normalization</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="splitChapters">
                    <label for="splitChapters">Split by Chapters (M4A only)</label>
                </div>
                <div class="form-group">
                    <label>Pipeline</label>
                    <select id="pipeline">
                        <option value="minimal">Minimal (conversion only)</option>
                        <option value="standard" selected>Standard (full processing)</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startProcessing()" style="width: 100%; font-size: 1.2em;">
                üöÄ Start Processing
            </button>
        </div>
        
        <!-- QUEUE TAB -->
        <div id="queue" class="tab-content">
            <div class="card">
                <h3>Active Jobs</h3>
                <ul id="jobsList" class="jobs-list">
                    <li style="text-align: center; color: #6c757d;">No active jobs</li>
                </ul>
            </div>
        </div>
        
        <!-- CONFIG TAB -->
        <div id="config" class="tab-content">
            <div class="card">
                <h3>Configuration</h3>
                <div id="configList">
                    <p style="color: #6c757d;">Loading configuration...</p>
                </div>
            </div>
        </div>
        
        <!-- CHECKPOINTS TAB -->
        <div id="checkpoints" class="tab-content">
            <div class="card">
                <h3>Available Checkpoints</h3>
                <ul id="checkpointsList" class="jobs-list">
                    <li style="text-align: center; color: #6c757d;">No checkpoints</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let ws = null;
        let uploadedFile = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadDashboard();
            loadConfig();
            loadCheckpoints();
        });
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'queue') loadJobs();
            if (tabName === 'checkpoints') loadCheckpoints();
        }
        
        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('connectionStatus').className = 'connected';
                document.getElementById('connectionStatus').textContent = '‚óè Connected';
            };
            
            ws.onclose = () => {
                document.getElementById('connectionStatus').className = 'disconnected';
                document.getElementById('connectionStatus').textContent = '‚óè Disconnected';
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }
        
        function handleWebSocketMessage(data) {
            if (data.type === 'status') {
                document.getElementById('statActiveJobs').textContent = data.active_jobs;
            }
            if (data.type === 'job_update') {
                loadJobs();
            }
        }
        
        // File upload
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            uploadedFile = file;
            document.getElementById('selectedFile').textContent = `Selected: ${file.name}`;
            
            // Auto-fill metadata from filename
            const guessedTitle = file.name.replace(/\.(m4a|m4b|opus|mp3)$/i, '');
            if (guessedTitle.includes(' - ')) {
                const [author, title] = guessedTitle.split(' - ');
                document.getElementById('author').value = author.trim();
                document.getElementById('title').value = title.trim();
            } else {
                document.getElementById('title').value = guessedTitle;
            }
        }
        
        // Start processing
        async function startProcessing() {
            if (!uploadedFile) {
                showAlert('error', 'Please select a file first!');
                return;
            }
            
            const author = document.getElementById('author').value;
            const title = document.getElementById('title').value;
            
            if (!author || !title) {
                showAlert('error', 'Author and Title are required!');
                return;
            }
            
            // Upload file
            const formData = new FormData();
            formData.append('file', uploadedFile);
            
            showAlert('success', 'Uploading file...');
            
            try {
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadResponse.json();
                
                // Start processing
                const processFormData = new FormData();
                processFormData.append('filename', uploadData.filename);
                processFormData.append('author', author);
                processFormData.append('title', title);
                processFormData.append('year', document.getElementById('year').value || '');
                processFormData.append('bitrate', document.getElementById('bitrate').value);
                processFormData.append('loudnorm', document.getElementById('loudnorm').checked);
                processFormData.append('split_chapters', document.getElementById('splitChapters').checked);
                processFormData.append('pipeline', document.getElementById('pipeline').value);
                
                const processResponse = await fetch('/api/process', {
                    method: 'POST',
                    body: processFormData
                });
                const processData = await processResponse.json();
                
                showAlert('success', `Processing started! Job ID: ${processData.job_id}`);
                
                // Switch to queue tab
                setTimeout(() => {
                    document.querySelector('[onclick*="queue"]').click();
                }, 2000);
                
            } catch (error) {
                showAlert('error', `Error: ${error.message}`);
            }
        }
        
        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('systemStatus').textContent = data.status;
                document.getElementById('statActiveJobs').textContent = data.active_jobs;
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }
        
        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                
                const jobsList = document.getElementById('jobsList');
                
                if (jobs.length === 0) {
                    jobsList.innerHTML = '<li style="text-align: center; color: #6c757d;">No active jobs</li>';
                    return;
                }
                
                jobsList.innerHTML = jobs.map(job => `
                    <li class="job-item">
                        <div class="job-info" style="flex: 1;">
                            <h4>${job.title} - ${job.author}</h4>
                            <p>Step: ${job.current_step || 'Starting...'}</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${job.progress * 100}%"></div>
                            </div>
                        </div>
                        <span class="status-badge status-${job.state}">${job.state}</span>
                    </li>
                `).join('');
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }
        
        // Load config
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                const configList = document.getElementById('configList');
                configList.innerHTML = Object.entries(config).map(([key, data]) => `
                    <div class="config-item">
                        <label>${key}</label>
                        <input type="text" value="${data.value}" data-key="${key}">
                        <small style="color: #6c757d; margin-left: 10px;">from ${data.source}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }
        
        // Load checkpoints
        async function loadCheckpoints() {
            try {
                const response = await fetch('/api/checkpoints');
                const checkpoints = await response.json();
                
                const checkpointsList = document.getElementById('checkpointsList');
                
                if (checkpoints.length === 0) {
                    checkpointsList.innerHTML = '<li style="text-align: center; color: #6c757d;">No checkpoints</li>';
                    return;
                }
                
                checkpointsList.innerHTML = checkpoints.map(cp => `
                    <li class="job-item">
                        <div class="job-info">
                            <h4>${cp.title} - ${cp.author}</h4>
                            <p>Progress: ${(cp.progress * 100).toFixed(0)}%</p>
                        </div>
                        <button class="btn btn-primary" onclick="resumeCheckpoint('${cp.id}')">
                            Resume
                        </button>
                    </li>
                `).join('');
            } catch (error) {
                console.error('Failed to load checkpoints:', error);
            }
        }
        
        // Resume checkpoint
        async function resumeCheckpoint(checkpointId) {
            try {
                const response = await fetch(`/api/checkpoints/${checkpointId}/resume`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                alert(`Processing resumed! Job ID: ${data.job_id}`);
                
                // Switch to queue tab
                document.querySelector('[onclick*="queue"]').click();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Show alert
        function showAlert(type, message) {
            const alert = document.getElementById('uploadAlert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }
        
        // Auto-refresh
        setInterval(() => {
            if (document.getElementById('queue').classList.contains('active')) {
                loadJobs();
            }
        }, 2000);
    </script>
</body>
</html>
