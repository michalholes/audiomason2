{% extends "base.html" %}

{% block title %}Configuration - AudioMason v2{% endblock %}

{% block content %}
<div class="card">
    <h3>Current Configuration</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        View and manage AudioMason configuration. Settings are loaded from CLI args, environment variables, config files, and defaults.
    </p>
    
    {% if config %}
    <table class="table">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody>
            {% for key, data in config.items() %}
            <tr>
                <td><strong>{{ key }}</strong></td>
                <td>
                    {% if data.value is sameas true %}
                        <span class="badge badge-success">True</span>
                    {% elif data.value is sameas false %}
                        <span class="badge badge-danger">False</span>
                    {% elif data.value is none %}
                        <span class="badge badge-warning">None</span>
                    {% else %}
                        <code>{{ data.value }}</code>
                    {% endif %}
                </td>
                <td>
                    {% if data.source == "cli" %}
                        <span class="badge badge-info">CLI Args</span>
                    {% elif data.source == "env" %}
                        <span class="badge badge-success">Environment</span>
                    {% elif data.source == "user_config" %}
                        <span class="badge badge-warning">User Config</span>
                    {% elif data.source == "system_config" %}
                        <span class="badge badge-warning">System Config</span>
                    {% elif data.source == "default" %}
                        <span class="badge">Default</span>
                    {% else %}
                        <span class="badge">{{ data.source }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #6c757d; text-align: center; padding: 40px;">
        No configuration loaded
    </p>
    {% endif %}
</div>

<div class="card">
    <h3>Configuration Priority</h3>
    <div style="background: white; padding: 20px; border-radius: 8px;">
        <ol style="color: #495057; line-height: 2;">
            <li><span class="badge badge-info">CLI Args</span> - Highest priority (command-line arguments)</li>
            <li><span class="badge badge-success">Environment</span> - Environment variables (AUDIOMASON_*)</li>
            <li><span class="badge badge-warning">User Config</span> - ~/.config/audiomason/config.yaml</li>
            <li><span class="badge badge-warning">System Config</span> - /etc/audiomason/config.yaml</li>
            <li><span class="badge">Default</span> - Lowest priority (built-in defaults)</li>
        </ol>
    </div>
</div>

<div class="card">
    <h3>Edit Configuration</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        Edit configuration values. Changes will be saved to <code>~/.config/audiomason/config.yaml</code>.
    </p>
    
    <form id="configForm">
        {% for key, data in config.items() %}
        <div class="form-group">
            <label>
                <strong>{{ key }}</strong>
                <span style="color: #6c757d; font-size: 0.9em; margin-left: 10px;">({{ data.source }})</span>
            </label>
            
            {% if data.value is sameas true or data.value is sameas false %}
                <label class="checkbox-group">
                    <input type="checkbox" name="{{ key }}" {% if data.value %}checked{% endif %}>
                    Enable
                </label>
            {% elif data.value is number %}
                <input type="number" name="{{ key }}" value="{{ data.value }}">
            {% else %}
                <input type="text" name="{{ key }}" value="{{ data.value if data.value is not none else '' }}">
            {% endif %}
        </div>
        {% endfor %}
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
            <button type="button" class="btn btn-secondary" onclick="location.reload()">üîÑ Reset</button>
            <button type="button" class="btn btn-danger" onclick="resetToDefaults()">‚ö†Ô∏è Reset to Defaults</button>
        </div>
    </form>
</div>

<script>
// Save configuration
document.getElementById('configForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const config = {};
    
    for (let [key, value] of formData.entries()) {
        // Handle checkboxes
        const input = document.querySelector(`input[name="${key}"]`);
        if (input.type === 'checkbox') {
            config[key] = input.checked;
        } else if (input.type === 'number') {
            config[key] = parseFloat(value);
        } else {
            config[key] = value;
        }
    }
    
    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Save failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Reset to defaults
async function resetToDefaults() {
    if (!confirm('Reset all configuration to defaults? This cannot be undone.')) return;
    
    try {
        const response = await fetch('/api/config/reset', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Reset failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
