{% extends "base.html" %}

{% block title %}Dashboard - AudioMason v2{% endblock %}

{% block content %}
<div class="card">
    <h3>System Status</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #28a745; margin-bottom: 10px;">{{ status.status|upper }}</div>
            <div style="color: #6c757d; font-size: 0.9em;">System Status</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #667eea; margin-bottom: 10px;">{{ status.active_jobs }}</div>
            <div style="color: #6c757d; font-size: 0.9em;">Active Jobs</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #17a2b8; margin-bottom: 10px;">{{ status.plugins_loaded }}</div>
            <div style="color: #6c757d; font-size: 0.9em;">Plugins</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #ffc107; margin-bottom: 10px;">{{ status.wizards_available }}</div>
            <div style="color: #6c757d; font-size: 0.9em;">Wizards</div>
        </div>
    </div>
</div>

<div class="card">
    <h3>Upload & Process Files</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        Upload multiple audio files, ZIP archives, or drag & drop folders to process audiobooks.
    </p>
    
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label>Select Files</label>
            <input type="file" id="audioFiles" name="files" multiple accept=".mp3,.m4a,.m4b,.opus,.zip" 
                   style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; cursor: pointer;">
            <small style="color: #6c757d; display: block; margin-top: 5px;">
                Supported: MP3, M4A, M4B, Opus, ZIP archives
            </small>
        </div>
        
        <div id="fileList" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: none;">
            <h4 style="margin-bottom: 10px; color: #667eea;">Selected Files:</h4>
            <ul id="fileListItems" style="list-style: none; padding: 0;"></ul>
        </div>
        
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">
            ðŸ“¤ Upload Files
        </button>
    </form>
</div>

<div class="card">
    <h3>Recent Jobs</h3>
    {% if jobs %}
    <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td><strong>{{ job.title }}</strong></td>
                <td>{{ job.author }}</td>
                <td>
                    {% if job.state == "DONE" %}
                        <span class="badge badge-success">Done</span>
                    {% elif job.state == "ERROR" %}
                        <span class="badge badge-danger">Error</span>
                    {% elif job.state == "PROCESSING" %}
                        <span class="badge badge-info">Processing</span>
                    {% else %}
                        <span class="badge badge-warning">{{ job.state }}</span>
                    {% endif %}
                </td>
                <td>
                    <div style="background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="background: #667eea; color: white; padding: 4px 8px; width: {{ job.progress * 100 }}%;">
                            {{ (job.progress * 100)|round }}%
                        </div>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="cancelJob('{{ job.id }}')">Cancel</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #6c757d; text-align: center; padding: 40px;">
        No jobs yet. Upload files to get started!
    </p>
    {% endif %}
</div>

<script>
// File selection display
document.getElementById('audioFiles').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const fileList = document.getElementById('fileList');
    const fileListItems = document.getElementById('fileListItems');
    
    if (files.length > 0) {
        fileListItems.innerHTML = files.map(f => 
            `<li style="padding: 8px; border-bottom: 1px solid #ddd;">
                <span style="color: #667eea;">ðŸ“„</span> ${f.name} 
                <span style="color: #6c757d; font-size: 0.9em;">(${(f.size / 1024 / 1024).toFixed(2)} MB)</span>
            </li>`
        ).join('');
        fileList.style.display = 'block';
    } else {
        fileList.style.display = 'none';
    }
});

// Upload form submission
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'â³ Uploading...';
    
    const formData = new FormData();
    const files = document.getElementById('audioFiles').files;
    
    if (files.length === 0) {
        alert('Please select files first');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        return;
    }
    
    for (let file of files) {
        formData.append('files', file);
    }
    
    try {
        // Set longer timeout (5 minutes)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000);
        
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Upload failed: ' + (result.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            alert('Upload timeout - files may be too large or connection too slow');
        } else {
            alert('Upload error: ' + error.message);
        }
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// Cancel job
async function cancelJob(jobId) {
    if (!confirm('Cancel this job?')) return;
    
    try {
        const response = await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Failed to cancel: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
