{% extends "base.html" %}

{% block title %}Dashboard - AudioMason v2{% endblock %}

{% block content %}
<div class="card">
    <h3>System Status</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; color: #667eea; margin-bottom: 10px;">
                <span class="status-indicator status-{{ status.status }}"></span>
                {{ status.status|upper }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">System Status</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; color: #667eea; margin-bottom: 10px;">
                {{ status.active_jobs }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Active Jobs</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; color: #667eea; margin-bottom: 10px;">
                {{ status.total_plugins }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Loaded Plugins</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; color: #667eea; margin-bottom: 10px;">
                v{{ status.version }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Version</div>
        </div>
    </div>
</div>

<div class="card">
    <h3>Quick Actions</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
        <a href="/jobs" class="btn btn-primary" style="text-align: center;">
            üìä View Jobs
        </a>
        <a href="/plugins" class="btn btn-primary" style="text-align: center;">
            üîå Manage Plugins
        </a>
        <a href="/config" class="btn btn-primary" style="text-align: center;">
            ‚öôÔ∏è Configuration
        </a>
        <a href="/wizards" class="btn btn-primary" style="text-align: center;">
            üßô Run Wizard
        </a>
    </div>
</div>

<div class="card">
    <h3>Upload & Process</h3>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label>Audio File</label>
            <input type="file" name="file" accept="audio/*,.m4b" required>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Author</label>
                <input type="text" name="author" placeholder="Author name" required>
            </div>
            
            <div class="form-group">
                <label>Title</label>
                <input type="text" name="title" placeholder="Book title" required>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Year</label>
                <input type="number" name="year" placeholder="2024" min="1900" max="2100">
            </div>
            
            <div class="form-group">
                <label>Bitrate</label>
                <select name="bitrate">
                    <option value="64k">64 kbps</option>
                    <option value="96k">96 kbps</option>
                    <option value="128k" selected>128 kbps</option>
                    <option value="192k">192 kbps</option>
                    <option value="256k">256 kbps</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Pipeline</label>
                <select name="pipeline">
                    <option value="standard" selected>Standard</option>
                    <option value="minimal">Minimal</option>
                    <option value="full">Full Processing</option>
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>
                    <input type="checkbox" name="loudnorm" style="width: auto; margin-right: 8px;">
                    Loudness Normalization
                </label>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="split_chapters" style="width: auto; margin-right: 8px;">
                    Split by Chapters
                </label>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
            üöÄ Upload & Process
        </button>
    </form>
</div>

<div class="card">
    <h3>Recent Activity</h3>
    <p style="color: #6c757d;">
        {% if active_jobs > 0 %}
            {{ active_jobs }} job(s) currently processing
        {% else %}
            No active jobs
        {% endif %}
    </p>
    <a href="/jobs" class="btn btn-primary" style="margin-top: 15px;">
        View All Jobs ‚Üí
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const fileInput = formData.get('file');
    
    if (!fileInput || fileInput.size === 0) {
        alert('Please select a file');
        return;
    }
    
    try {
        // Upload file first
        const uploadData = new FormData();
        uploadData.append('file', fileInput);
        
        const uploadResponse = await fetch('/api/upload', {
            method: 'POST',
            body: uploadData
        });
        
        if (!uploadResponse.ok) {
            throw new Error('Upload failed');
        }
        
        const uploadResult = await uploadResponse.json();
        
        // Start processing
        const processData = new FormData();
        processData.append('filename', uploadResult.filename);
        processData.append('author', formData.get('author'));
        processData.append('title', formData.get('title'));
        processData.append('year', formData.get('year') || '');
        processData.append('bitrate', formData.get('bitrate'));
        processData.append('loudnorm', formData.get('loudnorm') ? 'true' : 'false');
        processData.append('split_chapters', formData.get('split_chapters') ? 'true' : 'false');
        processData.append('pipeline', formData.get('pipeline'));
        
        const processResponse = await fetch('/api/process', {
            method: 'POST',
            body: processData
        });
        
        if (!processResponse.ok) {
            throw new Error('Processing start failed');
        }
        
        const processResult = await processResponse.json();
        
        alert(`Processing started! Job ID: ${processResult.job_id}`);
        window.location.href = '/jobs';
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
});
</script>
{% endblock %}
