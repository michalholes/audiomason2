{% extends "base.html" %}

{% block title %}Jobs - AudioMason v2{% endblock %}

{% block content %}
<div class="card">
    <h3>Processing Jobs ({{ jobs|length }})</h3>
    
    {% if jobs %}
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>State</th>
                <th>Progress</th>
                <th>Current Step</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td><code>{{ job.id[:8] }}...</code></td>
                <td><strong>{{ job.title }}</strong></td>
                <td>{{ job.author }}</td>
                <td>
                    {% if job.state == "PROCESSING" %}
                        <span class="badge badge-info">Processing</span>
                    {% elif job.state == "COMPLETE" %}
                        <span class="badge badge-success">Complete</span>
                    {% elif job.state == "ERROR" %}
                        <span class="badge badge-danger">Error</span>
                    {% elif job.state == "INTERRUPTED" %}
                        <span class="badge badge-warning">Interrupted</span>
                    {% else %}
                        <span class="badge">{{ job.state }}</span>
                    {% endif %}
                </td>
                <td>
                    <div class="progress-bar" style="height: 20px;">
                        <div class="progress-fill" style="width: {{ job.progress }}%;">
                            {{ job.progress }}%
                        </div>
                    </div>
                </td>
                <td>{{ job.current_step }}</td>
                <td>
                    <button class="btn btn-danger" onclick="cancelJob('{{ job.id }}')" 
                            {% if job.state != "PROCESSING" %}disabled{% endif %}>
                        Cancel
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #6c757d; text-align: center; padding: 40px;">
        No jobs found. Upload a file from the <a href="/" style="color: #667eea;">Dashboard</a> to start processing.
    </p>
    {% endif %}
</div>

<div class="card">
    <h3>Job Statistics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #667eea; margin-bottom: 10px;">
                {{ jobs|length }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Total Jobs</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #17a2b8; margin-bottom: 10px;">
                {{ jobs|selectattr('state', 'equalto', 'PROCESSING')|list|length }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Processing</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #28a745; margin-bottom: 10px;">
                {{ jobs|selectattr('state', 'equalto', 'COMPLETE')|list|length }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Completed</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; color: #dc3545; margin-bottom: 10px;">
                {{ jobs|selectattr('state', 'equalto', 'ERROR')|list|length }}
            </div>
            <div style="color: #6c757d; font-size: 0.9em;">Errors</div>
        </div>
    </div>
</div>

<div class="card">
    <h3>Real-Time Updates</h3>
    <div id="liveStatus" style="background: white; padding: 20px; border-radius: 8px;">
        <p style="color: #6c757d;">Connecting to WebSocket...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function cancelJob(jobId) {
    if (!confirm('Are you sure you want to cancel this job?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/jobs/${jobId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to cancel job');
        }
        
        alert('Job cancelled successfully');
        location.reload();
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// WebSocket connection for real-time updates
const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

ws.onopen = () => {
    document.getElementById('liveStatus').innerHTML = `
        <p style="color: #28a745;">
            <span class="status-indicator status-running"></span>
            Connected to live updates
        </p>
    `;
};

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    
    if (data.type === 'job_update') {
        // Reload page on job updates
        location.reload();
    }
};

ws.onerror = () => {
    document.getElementById('liveStatus').innerHTML = `
        <p style="color: #dc3545;">
            <span class="status-indicator status-error"></span>
            WebSocket connection error
        </p>
    `;
};

ws.onclose = () => {
    document.getElementById('liveStatus').innerHTML = `
        <p style="color: #ffc107;">
            <span class="status-indicator status-warning"></span>
            WebSocket disconnected
        </p>
    `;
};

// Auto-refresh every 5 seconds
setInterval(() => {
    location.reload();
}, 5000);
</script>
{% endblock %}
